<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NeuroStockViz - Explore Stock Correlations</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; overflow: hidden; }
    .node { stroke: #fff; stroke-width: 1.5px; }
    .link { stroke: #999; stroke-opacity: 0.6; }
    .highlight { stroke: red; stroke-width: 3px; }
    #controls { margin: 10px 20px; font-size: 14px; }
    .tooltip {
      position: absolute;
      background: rgba(255, 255, 255, 0.9);
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      pointer-events: none;
      font-size: 12px;
      color: #333;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
    }
    #layoutContainer {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin: 10px 20px;
      height: calc(100vh - 160px);
    }
    .side-panel {
      width: 200px;
      font-size: 13px;
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      padding: 6px;
      overflow-y: auto;
      min-height: 100%;
    }
    #graphContainer {
      flex: 1;
      height: 100%;
    }
    svg {
      width: 100%;
      height: 100%;
    }
    header {
      padding: 10px;
    }
  </style>
</head>
<body>
  <header style="background-color: #333; color: white; padding: 10px; text-align: center;">
    <h2>NeuroStockViz</h2>
    <p style="margin: 5px;">Visualize stock correlations like a neural network.</p>
    <a href="/home" style="color: #00c8ff; text-decoration: underline;">Back to Home</a>
  </header>
  <div id="controls">
    <label for="stockSelect">Select Stock: </label>
    <select id="stockSelect">
      <option value="">--None--</option>
    </select>
    <label for="threshold">Correlation Threshold: </label>
    <input type="range" id="threshold" min="0" max="1" step="0.05" value="0.5">
    <span id="thresholdValue">0.5</span>
    <label for="startYear">Start Year: </label>
    <input type="number" id="startYear" value="2014" min="2010" max="2024">
    <label for="endYear">End Year: </label>
    <input type="number" id="endYear" value="2024" min="2014" max="2024">
    <button id="updateButton">Update Visualization</button>
  </div>
  <div id="layoutContainer">
    <div id="correlatedList" class="side-panel"></div>
    <div id="graphContainer">
      <svg width="1000" height="500" viewBox="0 0 1000 500" preserveAspectRatio="xMidYMid meet"></svg>
    </div>
    <div id="nonCorrelatedList" class="side-panel"></div>
    <div id="indirectlyCorrelatedList" class="side-panel"></div>
  </div>
  <div id="tooltip" class="tooltip" style="display: none;"></div>
  <script>
    const stockList = ["AAPL", "MSFT", "GOOGL", "AMZN", "JNJ", "V", "WMT", "JPM", "PG", "UNH", "AXP", "BA", "CAT", "CSCO", "CVX", "DIS", "GS", "HD", "HON", "IBM", "INTC", "KO", "MCD", "MMM", "MRK", "NKE", "TRV", "WBA", "XOM", "DOW"];
    const selectElement = document.getElementById("stockSelect");
    stockList.forEach(stock => {
      const option = document.createElement("option");
      option.value = stock;
      option.text = stock;
      selectElement.appendChild(option);
    });

    const svg = d3.select("svg"),
          width = +svg.attr("width"),
          height = +svg.attr("height");

    let simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(d => d.id).distance(150))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(500, 250));

    const color = d3.scaleOrdinal(d3.schemeCategory10);
    const tooltip = d3.select("#tooltip");

    document.getElementById("threshold").addEventListener("input", function() {
      document.getElementById("thresholdValue").textContent = this.value;
    });

    function updateGraph(data) {
      svg.selectAll("*").remove();
      const selectedStock = document.getElementById("stockSelect").value;

      data.nodes.sort((a, b) => a.id === selectedStock ? -1 : b.id === selectedStock ? 1 : 0);

      const link = svg.append("g")
          .attr("class", "links")
          .selectAll("line")
          .data(data.edges)
          .enter()
          .append("line")
          .attr("class", d => d.highlight ? "link highlight" : "link")
          .attr("stroke-width", d => Math.abs(d.value) * 2)
          .on("mouseover", function(event, d) {
              tooltip.style("display", "block").html(`${d.source.id} - ${d.target.id}<br>Correlation: ${d.value.toFixed(2)}`);
          })
          .on("mousemove", function(event) {
              tooltip.style("left", (event.pageX + 10) + "px").style("top", (event.pageY + 10) + "px");
          })
          .on("mouseout", () => tooltip.style("display", "none"));

      const node = svg.append("g")
          .attr("class", "nodes")
          .selectAll("g")
          .data(data.nodes)
          .enter().append("g")
          .call(d3.drag()
              .on("start", dragstarted)
              .on("drag", dragged)
              .on("end", dragended));

      node.append("circle")
          .attr("r", 10)
          .attr("fill", d => color(d.id))
          .attr("stroke", d => d.id === selectedStock ? "black" : "#fff")
          .attr("stroke-width", d => d.id === selectedStock ? 3 : 1.5);

      node.append("text")
          .attr("x", 12)
          .attr("y", 3)
          .text(d => d.id)
          .style("font-size", "12px")
          .style("fill", "#333");

      simulation.nodes(data.nodes);
      if (selectedStock) {
        const selectedNode = data.nodes.find(n => n.id === selectedStock);
        if (selectedNode) {
          selectedNode.fx = width / 2;
          selectedNode.fy = 50; // Fixed high position
        }

        const directlyConnected = data.edges
        .filter(e => e.source.id === selectedStock || e.target.id === selectedStock)
        .map(e => e.source.id === selectedStock ? e.target : e.source);
        directlyConnected.forEach((node, i) => {
          const angle = (2 * Math.PI / directlyConnected.length) * i;
          const radius = 350;
          node.fx = width / 2 + radius * Math.cos(angle);
          node.fy = 300 + radius * Math.sin(angle); // Push connected nodes further down
        });
    }

      simulation.force("link").links(data.edges);
      simulation.alpha(1).restart();

      simulation.on("tick", () => {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);
        node.attr("transform", d => `translate(${d.x},${d.y})`);
      });

      const formatList = list =>
        list.sort((a, b) => Math.abs(parseFloat(b.split(": ")[1])) - Math.abs(parseFloat(a.split(": ")[1])))
            .map(entry => {
              const val = parseFloat(entry.split(": ")[1]);
              const color = val >= 0 ? "green" : "crimson";
              return `<span style="color:${color}">${entry}</span>`;
            }).join("<br>");

      document.getElementById("correlatedList").innerHTML = "<b>Correlated Stocks</b><br>" + formatList(data.correlated);
      const cleanedNonCorrelated = (data.non_correlated || []).filter(entry => {
        const ticker = entry.split(":")[0];
        return !(data.indirectly_correlated || []).some(indirect => indirect.startsWith(ticker + ":"));
      });
      document.getElementById("nonCorrelatedList").innerHTML = "<b>Non-Correlated Stocks</b><br>" + formatList(cleanedNonCorrelated);
      document.getElementById("indirectlyCorrelatedList").innerHTML = "<b>Indirectly Correlated Stocks</b><br>" + formatList(data.indirectly_correlated || []);
    }

    function dragstarted(event, d) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }
    function dragged(event, d) {
      d.fx = event.x;
      d.fy = event.y;
    }
    function dragended(event, d) {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }

    function fetchData() {
      const startYear = document.getElementById("startYear").value;
      const endYear = document.getElementById("endYear").value;
      const selectedStock = document.getElementById("stockSelect").value;
      const threshold = document.getElementById("threshold").value;
      const url = `/api/correlations?start_year=${startYear}&end_year=${endYear}&selected_stock=${selectedStock}&threshold=${threshold}`;
      fetch(url)
        .then(response => response.json())
        .then(data => {
          data.edges = data.edges.filter(d => Math.abs(d.value) >= parseFloat(threshold));
          updateGraph(data);
        });
    }

    document.getElementById("updateButton").addEventListener("click", fetchData);
    fetchData();
  </script>
</body>
</html>